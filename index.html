<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Chronos - Time Series Manager</title>
    <link rel="icon" type="image/png" href="icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
        darkMode: 'class',
    }
    </script>
    <script type="module" src="https://unpkg.com/alpinejs@3.x.x/dist/module.esm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.0/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script type="module" src="./multiselect.js"></script>
    <script type="module" src="./calendar.js"></script>
    <script type="module" src="./db.js"></script>
    <script type="module" src="./seriecard.js"></script>
    <script type="module" src="./analytics.js"></script>
    <script type="module" src="./utils.js"></script>
    <script type="module" src="./chart-config.js"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Better touch targets for mobile inputs */
        @media (max-width: 640px) {
            input, select, button {
                min-height: 44px; /* Apple/Google recommended touch size */
            }
        }

        [x-cloak] { display: none !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: #cbd5e1; 
            border-radius: 10px; 
        }

        /* Dark mode scrollbar */
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: #475569; 
        }

        /* Dark mode transitions */
        * {
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
    </style>
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js')
            .then(reg => console.log('Service Worker registered', reg))
            .catch(err => console.error('Service Worker registration failed', err));
        });
      }
      // ADD THIS BLOCK TO PREVENT the mini-infobar from appearing on mobile
      window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); });
    </script>
    <!-- PWA -->
</head>
<body class="bg-slate-50 text-slate-900 font-sans dark:bg-slate-900 dark:text-slate-100" x-data="app">
    <header class="bg-white border-b border-slate-200 sticky top-0 z-30 dark:bg-slate-800 dark:border-slate-700">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <div x-show="view !== 'detail'" class="flex items-center space-x-2 cursor-pointer" @click="view = 'list'">
                    <div class="bg-indigo-600 p-2 rounded-lg text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                    <h1 class="text-xl font-bold tracking-tight text-slate-800 dark:text-slate-100">Chronos</h1>
                    <div class="flex items-center space-x-3">
                        <div x-data="{ open: false }" class="relative" @click.away="open = false">
                            <button @click="open = !open" class="flex items-center space-x-2 px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg transition-colors dark:text-slate-300 dark:hover:bg-slate-700">
                                <i class="fa-solid fa-file-import"></i>
                                <span>Data</span>
                                <i class="fa-solid fa-chevron-down text-[10px]"></i>
                            </button>

                            <div x-show="open" x-cloak 
                                 class="absolute right-0 mt-2 w-48 bg-white border border-slate-200 rounded-xl shadow-lg z-50 py-1 overflow-hidden dark:bg-slate-800 dark:border-slate-700">
                                
                                <div class="px-3 py-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-50 dark:border-slate-700 dark:text-slate-500">Transfer</div>
                                
                                <button @click="exportData(); open = false" class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-indigo-50 hover:text-indigo-600 flex items-center dark:text-slate-300 dark:hover:bg-slate-700 dark:hover:text-indigo-400">
                                    <i class="fa-solid fa-download w-5"></i> Export JSON
                                </button>
                                <label class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-indigo-50 hover:text-indigo-600 flex items-center cursor-pointer dark:text-slate-300 dark:hover:bg-slate-700 dark:hover:text-indigo-400">
                                    <i class="fa-solid fa-upload w-5"></i> Import JSON
                                    <input type="file" accept=".json,application/json" class="hidden" @change="importData($event); open = false">
                                </label>

                                <div class="border-t border-slate-100 my-1 dark:border-slate-700"></div>
                                
                                <button @click="exportCSV(); open = false" class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-indigo-50 hover:text-indigo-600 flex items-center dark:text-slate-300 dark:hover:bg-slate-700 dark:hover:text-indigo-400">
                                    <i class="fa-solid fa-file-csv w-5"></i> Export CSV
                                </button>
                                <label class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-indigo-50 hover:text-indigo-600 flex items-center cursor-pointer dark:text-slate-300 dark:hover:bg-slate-700 dark:hover:text-indigo-400">
                                    <i class="fa-solid fa-file-import w-5"></i> Import CSV
                                    <input type="file" accept=".csv,text/csv" class="hidden" @change="importCSV($event); open = false">
                                </label>

                                <div class="border-t border-slate-100 my-1 dark:border-slate-700"></div>
                                
                                <!-- Theme Toggle -->
                                <button @click="toggleTheme(); open = false" class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-indigo-50 hover:text-indigo-600 flex items-center dark:text-slate-300 dark:hover:bg-slate-700 dark:hover:text-indigo-400">
                                    <i class="fa-solid fa-moon w-5" x-show="theme === 'light'"></i>
                                    <i class="fa-solid fa-sun w-5" x-show="theme === 'dark'"></i>
                                    <span x-text="theme === 'light' ? 'Dark Mode' : 'Light Mode'"></span>
                                </button>
                            </div>
                        </div>
                        <div class="w-px h-6 bg-slate-200 dark:bg-slate-700"></div>
                        <button @click="modals.manageGroups = true; showAddGroupForm = false; editingGroup = null" class="text-slate-600 hover:text-indigo-600 text-sm font-medium dark:text-slate-300 dark:hover:text-indigo-400">Groups</button>
                        <button @click="openNewSeriesModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm dark:bg-indigo-700 dark:hover:bg-indigo-600">
                            + New Series
                        </button>
                    </div>
                </div>

                <template x-if="currentSeries">
                <div x-show="view === 'detail'" class="flex items-center justify-between w-full ml-3">
                    <div class="flex items-center space-x-3 flex-1">
                        <button @click="view = 'list'" class="p-2 -ml-2 text-slate-500 hover:text-indigo-600 hover:bg-slate-100 rounded-full transition-colors dark:text-slate-400 dark:hover:text-indigo-400 dark:hover:bg-slate-800">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <div class="relative flex items-center group cursor-text flex-1 max-w-md">
                            <input 
                                type="text" 
                                x-model="currentSeries.name" 
                                @change="updateSeriesName()"
                                @keydown.enter="$el.blur()"
                                class="bg-transparent border-b border-slate-300 focus:border-indigo-500 focus:bg-white dark:focus:bg-slate-800 text-xl font-bold tracking-tight text-slate-800 dark:text-slate-100 rounded-sm px-1 -ml-1 w-full outline-none transition-all pr-8"
                            >
                            <i class="fa-solid fa-pen text-[10px] text-slate-400 absolute right-2 pointer-events-none dark:text-slate-500"></i>
                        </div>
                    </div>
            
                    <button 
                        @click="if(confirm('Are you sure you want to delete this series?')) { deleteSeries(currentSeries.id); view = 'list'; }" 
                        class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors dark:text-slate-500 dark:hover:text-red-400 dark:hover:bg-red-900/20"
                        title="Delete Series"
                    >
                        <i class="fa-solid fa-trash-can text-lg"></i>
                    </button>
                </div>
                </template>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 pb-8">
        <template x-if="view === 'list'">
            <div class="space-y-6">
                <div class="py-1 border-b border-slate-200 flex flex-wrap items-center gap-y-3 dark:border-slate-700" :class="!showFilters ? 'gap-x-8' : ''" x-data="{ showFilters: true, showSort: true }">

                    <div class="flex items-center">
                        <span @click="showFilters = !showFilters" 
                              class="text-[10px] font-bold text-slate-400 tracking-widest dark:text-slate-500 cursor-pointer hover:text-indigo-600 transition-colors select-none">
                            FILTER
                        </span>
                        <div x-show="showFilters" x-collapse>
                            <multi-select class="max-w-44 ml-2"
                                :items="JSON.stringify(groups.map(g => ({ id: g.name, label: g.name, color: g.color })))"
                                :selected-ids="JSON.stringify(selectedGroups)"
                                multi
                                @change="selectedGroups = $event.detail.selection; localStorage.setItem('chronos_selectedGroups', JSON.stringify(selectedGroups))">
                            </multi-select>
                        </div>
                    </div>
                
                    <div class="flex items-center gap-4 border-t sm:border-t-0 border-slate-100 dark:border-slate-800">
                        <div class="flex items-center space-x-2">
                            <span @click="showSort = !showSort" 
                                  class="text-[10px] font-bold text-slate-400 tracking-widest dark:text-slate-500 cursor-pointer hover:text-indigo-600 transition-colors select-none">
                                SORT
                            </span>
                            <div x-show="showSort" x-collapse class="flex bg-slate-200/50 p-1 rounded-lg dark:bg-slate-800">
                                <button @click="sortBy('name')" 
                                        :class="sortField === 'name' ? 'bg-white text-indigo-600 shadow-sm dark:bg-slate-700 dark:text-indigo-400' : 'text-slate-500 dark:text-slate-400'"
                                        class="px-2 py-1 text-xs font-bold rounded-md transition-all flex items-center space-x-1">
                                    <span>Name</span>
                                    <span x-show="sortField === 'name'" x-text="sortOrder === 'asc' ? '↑' : '↓'"></span>
                                </button>
                                <button @click="sortBy('group')" 
                                        :class="sortField === 'group' ? 'bg-white text-indigo-600 shadow-sm dark:bg-slate-700 dark:text-indigo-400' : 'text-slate-500 dark:text-slate-400'"
                                        class="px-2 py-1 text-xs font-bold rounded-md transition-all flex items-center space-x-1">
                                    <span>Group</span>
                                    <span x-show="sortField === 'group'" x-text="sortOrder === 'asc' ? '↑' : '↓'"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 min-[400px]:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    <template x-for="s in filteredSeries" :key="s.id">
                        <serie-card
                            :series="JSON.stringify(s)"
                            :group="JSON.stringify(groups.find(g => g.name === s.group))"
                            @series-click="openSeriesDetail($event.detail.series)"
                            @add-entry-click="activeSeriesForEntry = $event.detail.series; modals.entry = true"
                            @series-updated="loadSeries()"
                            @entry-created="loadSeries(); if(currentSeries && currentSeries.id === $event.detail.seriesId) loadEntries(currentSeries.id)">
                        </serie-card>
                    </template>
                </div>
            </div>
        </template>

        <template x-if="view === 'detail'">
            <div class="space-y-6">
                <div class="flex items-center justify-between gap-4 py-2 border-b border-slate-200 dark:border-slate-700">                    
                    <div class="flex bg-slate-100 p-1 rounded-xl border border-slate-200 dark:bg-slate-800 dark:border-slate-700">
                        <template x-for="tab in [
                            {id: 'chart', icon: 'fa-chart-line'},
                            {id: 'analysis', icon: 'fa-square-root-variable'},
                            {id: 'calendar', icon: 'fa-calendar-days'},
                            {id: 'history', icon: 'fa-table-list'},
                            {id: 'config', icon: 'fa-gear'}
                        ]">
                            <button @click="changeSubView(tab.id)" 
                                    :class="detailSubView === tab.id ? 'bg-white text-indigo-600 shadow-sm dark:bg-slate-700 dark:text-indigo-400' : 'text-slate-500 dark:text-slate-400'" 
                                    class="px-3 py-1.5 rounded-lg text-sm transition-all flex justify-center items-center">
                                <i class="fa-solid" :class="tab.icon"></i>
                            </button>
                        </template>
                    </div>
                </div>

                <div x-show="detailSubView === 'chart'" class="bg-white p-2 mt-2 rounded-2xl shadow-sm border border-slate-200 dark:bg-slate-800 dark:border-slate-700">
                    
                    <div class="relative h-96">
                        <div class="absolute top-2 left-2 z-10 flex items-center space-x-4">
                            <button 
                                @click="chartSettings.logScale = !chartSettings.logScale; updateChart(); saveSeriesConfig()"
                                :class="chartSettings.logScale ? 'text-indigo-600 dark:text-indigo-400 font-black ring-1 ring-indigo-600/20 px-1 rounded' : 'text-slate-300 dark:text-slate-600 font-bold'"
                                class="text-[10px] tracking-widest transition-colors hover:opacity-70"
                                title="Toggle Logarithmic Scale">
                                LOG
                            </button>
                        </div>
                        
                        <canvas id="seriesChart"></canvas>
                    </div>

                    <div class="p-4 border-t border-slate-100 dark:border-slate-700" x-data="{ showAllStats: false }">
                        <div>
                            <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest dark:text-slate-500">Statistics</h3>

                            <template x-if="metrics && metrics.length > 0">
                              <div class="flex felx-row gap-2 mt-2">
                                <multi-select 
                                  :items="JSON.stringify(metrics.map(m => ({ id: m.id, label: m.label, color: m.color })))"
                                  :selected-ids="JSON.stringify(analysisSelection)"
                                  multi
                                  @change="analysisSelection = $event.detail.selection; saveSeriesConfig(); updateChart()">
                                </multi-select>
                                <div class="flex flex-col gap-1.5">
                                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter dark:text-slate-500">Period Grouping</span>
                                    <select x-model="chartSettings.period" @change="updateChart(); saveSeriesConfig()" class="text-xs border border-slate-200 rounded-md px-2 py-1.5 bg-slate-50 outline-none focus:ring-1 focus:ring-indigo-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                                        <option value="none">Raw Data</option>
                                        <option value="day">Day</option>
                                        <option value="week">Week</option>
                                        <option value="month">Month</option>
                                        <option value="quarter">Quarter</option>
                                        <option value="year">Year</option>
                                    </select>
                                </div>
                              </div>
                            </template>
                        </div>

                        <div class="flex flex-wrap items-center gap-4 my-3">
                            <div class="flex flex-col gap-1.5">
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter dark:text-slate-500">Running Average/Stat</span>
                                <div class="flex items-center space-x-2">
                                    <select x-model="chartSettings.runningMetric" @change="updateChart(); saveSeriesConfig()" class="text-xs border border-slate-200 rounded-md px-2 py-1.5 bg-slate-50 outline-none focus:ring-1 focus:ring-indigo-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                                        <option value="">None</option>
                                        <template x-for="m in metrics" :key="m.id">
                                            <option :value="m.id" x-text="m.label"></option>
                                        </template>
                                    </select>
                                    <input type="number" x-model.number="chartSettings.window" @input="updateChart(); saveSeriesConfig()" min="2" step="1" placeholder="Win" class="w-14 text-xs border border-slate-200 rounded-md px-2 py-1.5 bg-slate-50 outline-none focus:ring-1 focus:ring-indigo-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-row gap-2 mt-4 pt-4 border-t border-slate-100 dark:border-slate-700">
                            <h3 class="content-center text-[10px] font-bold text-slate-400 uppercase tracking-widest dark:text-slate-500">Time Range</h3>
                            
                            <div class="flex flex-row gap-3 items-start sm:items-center">
                                <div class="relative max-w-xs">
                                    <select 
                                        x-model="chartSettings.range" 
                                        @change="updateChart(); saveSeriesConfig()"
                                        class="w-full pl-3 pr-10 py-2 text-xs font-bold border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-indigo-500 outline-none appearance-none cursor-pointer dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100"
                                    >
                                        <option value="all">All Time</option>
                                        <option value="day">Day</option>
                                        <option value="week">Week</option>
                                        <option value="month">Month</option>
                                        <option value="quarter">Quarter</option>
                                        <option value="year">Year</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-400">
                                        <i class="fa-solid fa-chevron-down text-[10px]"></i>
                                    </div>
                                </div>
                        
                                <template x-if="chartSettings.range === 'custom'">
                                    <div class="flex items-center space-x-2 animate-in fade-in slide-in-from-left-2 duration-200">
                                        <input 
                                            type="number" 
                                            x-model.number="chartSettings.customDays" 
                                            @input.debounce.500ms="updateChart(); saveSeriesConfig()"
                                            placeholder="Days"
                                            class="w-16 px-2 py-2 text-xs font-bold border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-indigo-500 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100"
                                        >
                                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tight">Days</span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <div x-show="detailSubView === 'analysis'" class="space-y-6" x-cloak>
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm dark:bg-slate-800 dark:border-slate-700">
                        <div class="mb-6">
                            <h3 class="font-bold text-slate-800 py-4 dark:text-slate-100">Statistics Selection</h3>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="m in metrics" :key="m.id">
                                    <button @click="analysisSelection.includes(m.id) ? analysisSelection = analysisSelection.filter(i => i !== m.id) : analysisSelection.push(m.id);saveSeriesConfig();updateChart()"
                                            :class="analysisSelection.includes(m.id) ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-600 border-slate-200 hover:border-indigo-300 dark:bg-slate-700 dark:text-slate-300 dark:border-slate-600 dark:hover:border-indigo-500'"
                                            class="px-3 py-1.5 rounded-lg border text-xs font-bold transition-all flex items-center space-x-2">
                                        <span x-text="m.label"></span>
                                    </button>
                                </template>
                            </div>
                        </div>

                        <div class="border-t border-slate-100 dark:border-slate-700">
                            <h3 class="font-bold text-slate-800 py-4 dark:text-slate-100">All Time Statistics</h3>
                            <div class="overflow-hidden rounded-xl border border-slate-100 dark:border-slate-700">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-50 text-slate-500 uppercase text-[10px] tracking-widest dark:bg-slate-700 dark:text-slate-400">
                                        <tr><th class="px-6 py-3">Statistic</th><th class="px-6 py-3">Value</th></tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                        <template x-for="stat in activeStats" :key="stat.label">
                                            <tr class="hover:bg-slate-50/50 transition-colors dark:hover:bg-slate-700/50">
                                                <td class="px-6 py-3 font-medium text-slate-600 dark:text-slate-300" x-text="stat.label"></td>
                                                <td class="px-6 py-3 text-indigo-600 font-black text-base dark:text-indigo-400" x-text="stat.value"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div x-show="detailSubView === 'calendar'" class="space-y-6" x-cloak>
                    <chronos-calendar
                        x-show="detailSubView === 'calendar'"
                        :series="JSON.stringify(currentSeries)"
                        :entries="JSON.stringify(currentSeriesEntries)"
                        @day-click="handleCalendarDayClick($event.detail)">
                    </chronos-calendar>
                </div>

                <div x-show="detailSubView === 'history'" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden dark:bg-slate-800 dark:border-slate-700" x-cloak>
                    <div class="p-6 border-b border-slate-100 flex justify-between items-center dark:border-slate-700">
                        <h3 class="text-lg font-semibold dark:text-slate-100">Data History</h3>
                        <button @click="openAddEntryModal(currentSeries)" class="text-sm bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium dark:bg-indigo-700 dark:hover:bg-indigo-600">+ Add Entry</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase tracking-wider font-semibold dark:bg-slate-700 dark:text-slate-400">
                                <tr><th class="px-6 py-3">Date</th><th class="px-6 py-3">Value</th><th class="px-6 py-3">Notes</th><th class="px-6 py-3 text-right">Actions</th></tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                <template x-for="entry in currentSeriesEntries" :key="entry.id">
                                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium dark:text-slate-300" x-text="entry.timestamp"></td>
                                        <td class="px-6 py-4 text-sm text-indigo-600 font-bold dark:text-indigo-400" x-text="currentSeries.type === 'time' ? formatDuration(entry.value) : entry.value"></td>
                                        <td class="px-6 py-4 text-sm text-slate-500 dark:text-slate-400" x-text="entry.notes || '-'"></td>
                                        <td class="px-6 py-4 text-right space-x-3">
                                            <button @click="editEntry(entry)" class="text-slate-400 hover:text-indigo-600 dark:text-slate-500 dark:hover:text-indigo-400">Edit</button>
                                            <button @click="deleteEntry(entry.id)" class="text-slate-400 hover:text-red-600 dark:text-slate-500 dark:hover:text-red-400">Delete</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div x-show="detailSubView === 'config'" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 dark:bg-slate-800 dark:border-slate-700" x-cloak>
                    <div class="max-w-4xl space-y-8">
                        <h3 class="text-lg font-bold text-slate-800 dark:text-slate-100">Configuration</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-wider dark:text-slate-500">Group</label>
                                <select 
                                    x-model="currentSeries.group" 
                                    @change="updateSeriesName()" 
                                    class="w-full px-3 py-2 border border-slate-200 rounded-lg outline-none focus:ring-1 focus:ring-indigo-500 bg-slate-50 text-xs font-bold text-slate-700 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100"
                                >
                                    <option value="">No Group</option>
                                    <template x-for="g in groups" :key="g.id">
                                        <option :value="g.name" x-text="g.name" :selected="g.name === currentSeries.group"></option>
                                    </template>
                                </select>
                            </div>

                            <div class="space-y-6">
                                <div class="flex items-center space-x-2 pb-2 border-b border-slate-100 dark:border-slate-700">
                                    <i class="fa-solid fa-calculator text-indigo-500 text-xs"></i>
                                    <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest dark:text-slate-500">Dashboard Summary</h4>
                                </div>

                                <div>
                                    <label class="block text-[10px] font-bold text-slate-400 mb-3 uppercase tracking-wider dark:text-slate-500">Target Metric</label>
                                    <div class="flex flex-wrap gap-2">
                                        <template x-for="m in metrics" :key="m.id">
                                            <button @click="currentSeries.config.stat = m.id; saveSeriesConfig()"
                                                    :class="currentSeries.config?.stat === m.id ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-600 border-slate-200 hover:border-indigo-300 dark:bg-slate-700 dark:text-slate-300 dark:border-slate-600 dark:hover:border-indigo-500'"
                                                    class="px-3 py-1.5 rounded-lg border text-xs font-bold transition-all flex items-center space-x-2">
                                                <span x-text="m.label"></span>
                                            </button>
                                        </template>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4 items-end">
                                    <div>
                                        <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-wider dark:text-slate-500">Period</label>
                                        <select x-model="currentSeries.config.period" @change="saveSeriesConfig()" class="w-full px-3 py-2 border border-slate-200 rounded-lg outline-none focus:ring-1 focus:ring-indigo-500 bg-slate-50 text-xs font-bold text-slate-700 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                                            <option value="all">All Data</option>
                                            <option value="day">Current Day</option>
                                            <option value="week">Current Week</option>
                                            <option value="month">Current Month</option>
                                            <option value="quarter">Current Quarter</option>
                                            <option value="year">Current Year</option>
                                        </select>
                                    </div>
                                    <div class="bg-indigo-50 border border-indigo-100 rounded-lg px-3 py-2 flex flex-col justify-center dark:bg-indigo-900/30 dark:border-indigo-800">
                                        <span class="text-[8px] font-black text-indigo-400 uppercase tracking-tighter dark:text-indigo-300">Preview</span>
                                        <span class="text-sm font-black text-indigo-600 truncate dark:text-indigo-400" x-text="currentSeries.summaryDisplay || 'No Data'"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-6">
                                <div class="flex items-center space-x-2 pb-2 border-b border-slate-100 dark:border-slate-700">
                                    <i class="fa-solid fa-bolt text-indigo-500 text-xs"></i>
                                    <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest dark:text-slate-500">Button Behavior</h4>
                                </div>

                                <div>
                                    <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-wider dark:text-slate-500">Quick Add (+) Action</label>
                                    <select x-model="currentSeries.config.quickAddAction" @change="saveSeriesConfig()" class="w-full px-3 py-2 border border-slate-200 rounded-lg outline-none focus:ring-1 focus:ring-indigo-500 bg-slate-50 text-xs font-bold text-slate-700 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                                        <option value="manual" :selected="'manual' === currentSeries.config.quickAddAction">Manual Entry Modal</option>
                                        <template x-if="currentSeries.type === 'number'">
                                            <option value="increment" :selected="'increment' === currentSeries.config.quickAddAction">One-Click (+1)</option>
                                        </template>
                                        <template x-if="currentSeries.type === 'time'">
                                            <optgroup label="Time Shortcuts">
                                            <option value="currentTime" :selected="'currentTime' === currentSeries.config.quickAddAction">Stamp Current Time</option>
                                            <option value="chronometer" :selected="'chronometer' === currentSeries.config.quickAddAction">Start/Stop Chronometer</option>
                                            </optgroup>
                                        </template>
                                    </select>
                                </div>

                                <div class="bg-slate-50 border border-slate-100 p-3 rounded-xl dark:bg-slate-700 dark:border-slate-600">
                                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1 dark:text-slate-500">How it works</p>
                                    <p class="text-[11px] text-slate-500 leading-relaxed italic dark:text-slate-400">
                                        Sets the action triggered by the <span class="font-bold text-indigo-600 dark:text-indigo-400">plus (+)</span> icon on your dashboard for this series.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </main>

    <div x-show="modals.manageGroups" @keydown.window.escape="modals.manageGroups = false" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-slate-900/50" @click="modals.manageGroups = false"></div>
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md relative z-10 overflow-hidden dark:bg-slate-800">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-slate-900 dark:text-slate-100" x-text="editingGroup ? 'Edit Group' : 'Manage Groups'"></h3>
                        <button 
                            x-show="!showAddGroupForm && !editingGroup" 
                            @click="showAddGroupForm = true; groupForm.name = ''; groupForm.color = '#6366f1';" 
                            class="text-xs font-bold text-indigo-600 hover:text-indigo-700 uppercase tracking-wider dark:text-indigo-400 dark:hover:text-indigo-300">
                            + Add New
                        </button>
                    </div>

                    <div x-show="showAddGroupForm || editingGroup" 
                         class="space-y-4 mb-6 p-4 bg-slate-50 rounded-xl border border-slate-100 dark:bg-slate-700 dark:border-slate-600">
                        
                        <input type="text" x-model="groupForm.name" placeholder="Group Name" 
                               class="w-full px-3 py-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-slate-600 dark:border-slate-500 dark:text-slate-100" 
                               @input.debounce.1000ms="editingGroup && saveGroup()"
                               @keydown.enter="saveGroup(); showAddGroupForm = false"
                               autofocus>
                        
                        <div class="grid grid-cols-6 gap-2">
                            <template x-for="color in ['#6366f1', '#ec4899', '#f43f5e', '#f59e0b', '#10b981', '#06b6d4', '#8b5cf6', '#475569', '#94a3b8', '#14b8a6', '#f97316', '#ef4444']">
                                <button @click="groupForm.color = color; if(editingGroup) saveGroup()" 
                                        :class="groupForm.color === color ? 'ring-2 ring-offset-2 ring-slate-400 dark:ring-slate-300' : ''"
                                        :style="`background-color: ${color}`"
                                        class="h-8 rounded-md transition-all"></button>
                            </template>
                        </div>
                        
                        <div class="flex gap-2">
                            <template x-if="!editingGroup">
                                <button @click="saveGroup(); showAddGroupForm = false" 
                                        class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium text-sm transition-colors hover:bg-indigo-700 dark:bg-indigo-700 dark:hover:bg-indigo-600">
                                    Save Group
                                </button>
                            </template>
                        </div>
                    </div>

                    <div class="max-h-64 overflow-y-auto custom-scrollbar">
                        <template x-for="g in groups" :key="g.id">
                            <div @click="editGroupName(g)" class="flex items-center justify-between hover:bg-slate-50 rounded-lg group transition-colors dark:hover:bg-slate-700">
                                <div class="flex items-center space-x-3">
                                    <div class="w-3 h-3 rounded-full" :style="`background-color: ${g.color}`"></div>
                                    <span x-text="g.name" class="font-medium text-slate-700 dark:text-slate-300"></span>
                                </div>
                                <button @click="deleteGroup(g.id)" class="p-1 text-slate-400 text-red-600 dark:text-red-400">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
                <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end dark:bg-slate-700 dark:border-slate-600">
                    <button @click="modals.manageGroups = false; showAddGroupForm = false; editingGroup = null" 
                            class="text-sm font-medium text-slate-600 hover:text-slate-800 transition-colors dark:text-slate-400 dark:hover:text-slate-300">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div x-show="modals.series" @keydown.window.escape="modals.series = false" @keydown.enter="saveSeries()" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-slate-900/50" @click="modals.series = false"></div>
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg relative z-10 overflow-hidden dark:bg-slate-800">
                <div class="p-6">
                    <h3 class="text-xl font-bold text-slate-900 dark:text-slate-100" x-text="editingSeries ? 'Edit Series' : 'Create New Series'"></h3>
                    <div class="mt-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Name</label>
                            <input type="text" x-model="seriesForm.name" class="w-full mt-1 px-4 py-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100" autofocus>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Type</label>
                            <select x-model="seriesForm.type" class="w-full mt-1 px-4 py-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                                <option value="number">Number</option>
                                <option value="time">Time</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Group</label>
                            <select x-model="seriesForm.group" class="w-full mt-1 px-4 py-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                                <option value="">Uncategorized</option>
                                <template x-for="g in groups" :key="g.id"><option :value="g.name" x-text="g.name"></option></template>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="px-6 py-4 bg-slate-50 flex justify-end space-x-3 dark:bg-slate-700">
                    <button @click="modals.series = false" class="px-4 py-2 text-sm font-medium text-slate-700 dark:text-slate-300">Cancel</button>
                    <button @click="saveSeries()" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg dark:bg-indigo-700 dark:hover:bg-indigo-600">Save Series</button>
                </div>
            </div>
        </div>
    </div>

    <div x-show="modals.entry" @keydown.window.escape="modals.entry = false" @keydown.enter="saveEntry()" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-slate-900/50" @click="modals.entry = false"></div>
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg relative z-10 overflow-hidden dark:bg-slate-800">
                <div class="p-6">
                    <h3 class="text-xl font-bold text-slate-900 dark:text-slate-100" x-text="editingEntry ? 'Edit Entry' : 'Add New Entry'"></h3>
                    <div class="mt-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Date & Time (UTC ISO Format)</label>
                            <input type="text" x-model="entryForm.timestamp" placeholder="2025-07-13 18:36:00.000Z" class="w-full mt-1 px-4 py-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100" autofocus>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Value</label>
                            
                            <template x-if="activeSeriesForEntry?.type !== 'time'">
                                <input type="number" step="any" x-model="entryForm.value" class="w-full mt-1 px-4 py-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                            </template>

                            <template x-if="activeSeriesForEntry?.type === 'time'">
                                <div class="grid grid-cols-4 gap-2 mt-1">
                                    <div>
                                        <span class="text-[10px] uppercase font-bold text-slate-400 dark:text-slate-500">Days</span>
                                        <input type="number" x-model.number="entryForm.dhms.d" min="0" class="w-full px-2 py-2 border rounded-lg text-center outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                                    </div>
                                    <div>
                                        <span class="text-[10px] uppercase font-bold text-slate-400 dark:text-slate-500">Hours</span>
                                        <input type="number" x-model.number="entryForm.dhms.h" min="0" max="23" class="w-full px-2 py-2 border rounded-lg text-center outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                                    </div>
                                    <div>
                                        <span class="text-[10px] uppercase font-bold text-slate-400 dark:text-slate-500">Mins</span>
                                        <input type="number" x-model.number="entryForm.dhms.m" min="0" max="59" class="w-full px-2 py-2 border rounded-lg text-center outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                                    </div>
                                    <div>
                                        <span class="text-[10px] uppercase font-bold text-slate-400 dark:text-slate-500">Secs</span>
                                        <input type="number" x-model.number="entryForm.dhms.s" min="0" max="59" class="w-full px-2 py-2 border rounded-lg text-center outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Notes (Optional)</label>
                            <input type="text" x-model="entryForm.notes" class="w-full mt-1 px-4 py-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-100">
                        </div>
                    </div>
                </div>
                <div class="px-6 py-4 bg-slate-50 flex justify-end space-x-3 dark:bg-slate-700">
                    <button @click="modals.entry = false" class="px-4 py-2 text-sm font-medium text-slate-700 dark:text-slate-300">Cancel</button>
                    <button @click="saveEntry()" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg dark:bg-indigo-700 dark:hover:bg-indigo-600">Save Entry</button>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-5 right-5 z-[100]" x-show="toast.show" x-transition x-cloak>
        <div class="bg-slate-800 text-white px-6 py-3 rounded-xl shadow-lg flex items-center space-x-3 dark:bg-slate-700">
            <span x-text="toast.message"></span>
            <button @click="toast.show = false" class="text-slate-400">&times;</button>
        </div>
    </div>

    <script type="module">
        import Alpine from 'https://unpkg.com/alpinejs@3.x.x/dist/module.esm.js'
        import {formatDuration, secondsToDHMS, getFormattedISO, getRunningTime} from './utils.js';
        import {calculateStats,getPeriodData,calculateRunningMetric,filterByRange,calculateSeriesSummary} from './analytics.js';
        import {initChart,getChartOptions,updateChart,prepareChartDatasets,updateChartTimeRange,getChartInstance,destroyChart} from './chart-config.js';
        import chronosDB from './db.js';
        Alpine.data('app', () => ({
                formatDuration, secondsToDHMS, getFormattedISO, getRunningTime,
                view: 'list', detailSubView: 'chart',
                series: [], groups: [], currentSeries: null, currentSeriesEntries: [],
                selectedGroups: [], sortField: 'name', sortOrder: 'asc',
                modals: { series: false, entry: false, manageGroups: false },
                showAddGroupForm: false,
                groupForm: { name: '', color: '#6366f1' }, editingGroup: null,
                editingSeries: null, 
                seriesForm: { name: '', group: '', type: 'number', config: { stat: 'mean', period: 'all', quickAddAction: 'manual' } },
                editingEntry: null, activeSeriesForEntry: null, 
                entryForm: { timestamp: '', value: '', notes: '', dhms: { d:0, h:0, m:0, s:0 } },
                toast: { show: false, message: '' },
                chartSettings: { period: 'none', logScale: false, runningMetric: '', window: 7, range: 'all', customDays: 30 },
                analysisSelection: ['mean', 'dayMean', 'count'],
                metrics: [
                    { id: 'mean', label: 'Mean', color: '#4f46e5' }, 
                    { id: 'dayMean', label: 'Day Mean', color: '#10b981' }, 
                    { id: 'sum', label: 'Sum', color: '#10b981' }, 
                    { id: 'count', label: 'Count', color: '#f59e0b' },
                    { id: 'min', label: 'Min', color: '#ef4444' }, { id: 'q1', label: 'Q1', color: '#8b5cf6' }, { id: 'median', label: 'Median', color: '#ec4899' },
                    { id: 'q3', label: 'Q3', color: '#06b6d4' }, { id: 'max', label: 'Max', color: '#1e293b' },
                    { id: 'first', label: 'First', color: '#6366f1' }, { id: 'last', label: 'Last', color: '#6366f1' }
                ],
                now: Date.now(),
                theme: localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'),
                init() {
                    setInterval(() => { this.now = Date.now(); }, 1000);
                    this.initTheme();
                    this.loadData();
                    
                    const savedGroups = localStorage.getItem('chronos_selectedGroups');
                    if (savedGroups) this.selectedGroups = JSON.parse(savedGroups);

                    const savedSortField = localStorage.getItem('chronos_sortField');
                    if (savedSortField) this.sortField = savedSortField;

                    const savedSortOrder = localStorage.getItem('chronos_sortOrder');
                    if (savedSortOrder) this.sortOrder = savedSortOrder;
                },

                async loadData() {
                    await this.loadGroups();
                    await this.loadSeries();
                },

                toggleTheme() {
                    this.theme = this.theme === 'light' ? 'dark' : 'light';
                    
                    localStorage.setItem('theme', this.theme);
                    
                    if (this.theme === 'dark') {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                },

                initTheme() {
                    const storedTheme = localStorage.getItem('theme');
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    const isDark = storedTheme === 'dark' || (!storedTheme && prefersDark);
                    
                    this.theme = isDark ? 'dark' : 'light';
                    
                    if (isDark) { 
                        document.documentElement.classList.add('dark');
                    } else {      
                        document.documentElement.classList.remove('dark'); 
                    }
                },

                async exportData() {
                    try {
                        const exportObj = await chronosDB.exportJSON();
                        const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `chronos_export_${new Date().toISOString().split('T')[0]}.json`;
                        a.click();
                        this.showToast('JSON Exported');
                    } catch (err) {
                        this.showToast('Export failed');
                    }
                },

                async importData(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const importObj = JSON.parse(e.target.result);
                            if (!confirm("Merge imported data?")) return;
                            await chronosDB.importJSON(importObj, true);
                            await this.loadData();
                            this.showToast('Data merged');
                        } catch (err) { 
                            alert("Invalid JSON file"); 
                        }
                    };
                    reader.readAsText(file);
                },

                async exportCSV() {
                    try {
                        const csv = await chronosDB.exportCSV();
                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement("a");
                        link.href = URL.createObjectURL(blob);
                        link.setAttribute("download", `chronos_export_${new Date().toISOString().split('T')[0]}.csv`);
                        link.click();
                        this.showToast('CSV Exported');
                    } catch (err) {
                        this.showToast('CSV Export failed');
                    }
                },

                async importCSV(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            await chronosDB.importCSV(e.target.result);
                            await this.loadData();
                            this.showToast("CSV Imported Successfully");
                        } catch (err) {
                            alert("Failed to import CSV");
                        }
                    };
                    reader.readAsText(file);
                },

                async loadGroups() {
                    this.groups = await chronosDB.getAllGroups();
                    this.groups.sort((a,b) => a.name.localeCompare(b.name));
                },

                async saveGroup() {
                    if (!this.groupForm.name.trim()) return;
                
                    if (this.editingGroup) {
                        const oldName = this.editingGroup.name;
                        const newName = this.groupForm.name.trim();
                
                        this.editingGroup.name = newName;
                        this.editingGroup.color = this.groupForm.color;
                
                        if (oldName !== newName) {
                            this.series.forEach(s => {
                                if (s.group === oldName) {
                                    s.group = newName;
                                }
                            });
                            
                            if (this.currentSeries && this.currentSeries.group === oldName) {
                                this.currentSeries.group = newName;
                            }
                        }
                    } else {
                        const groupData = {
                            name: this.groupForm.name.trim(),
                            color: this.groupForm.color
                        };
                        await chronosDB.saveGroup(groupData);
                    }
                
                    await this.loadGroups();
                    this.showAddGroupForm = false;
                    this.editingGroup = null;
                },

                editGroupName(g) {
                    this.editingGroup = g;
                    this.groupForm = { name: g.name, color: g.color || '#6366f1' };
                },

                async deleteGroup(id) {
                    if (!confirm('Delete group?')) return;
                    await chronosDB.deleteGroup(id);
                    await this.loadGroups();
                    this.showToast('Group deleted');
                },

                async loadSeries() {
                    this.series = await chronosDB.getAllSeries();
                },

                get filteredSeries() {
                    let res = this.series.filter(s => this.selectedGroups.length === 0 || this.selectedGroups.includes(s.group || ''));
                    return res.sort((a, b) => {
                        let fA = (a[this.sortField] || '').toString().toLowerCase();
                        let fB = (b[this.sortField] || '').toString().toLowerCase();
                        return this.sortOrder === 'asc' ? fA.localeCompare(fB) : fB.localeCompare(fA);
                    });
                },

                sortBy(field) {
                    if (this.sortField === field) {
                        this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.sortField = field;
                        this.sortOrder = 'asc';
                    }
                    localStorage.setItem('chronos_sortField', this.sortField);
                    localStorage.setItem('chronos_sortOrder', this.sortOrder);
                },
                
                openNewSeriesModal() { 
                    this.editingSeries = null; 
                    this.seriesForm = { name: '', group: '', type: 'number', config: { stat: 'mean', period: 'all', quickAddAction: 'manual' } }; 
                    this.modals.series = true; 
                },
                
                editSeries(s) { 
                    this.editingSeries = s; 
                    this.seriesForm = { ...s }; 
                    this.modals.series = true; 
                },
                
                async updateSeriesName() {
                    if (!this.currentSeries || !this.currentSeries.name.trim()) return;
                    const index = this.series.findIndex(s => s.id === this.currentSeries.id);
                    if (index !== -1) {
                        this.series[index].name = this.currentSeries.name;
                    }
                    await chronosDB.saveSeries(this.currentSeries);
                    await this.loadSeries();
                },

                async deleteSeries(id) {
                    if (!confirm('Delete series and all data?')) return;
                    await chronosDB.deleteSeries(id);
                    await this.loadSeries();
                    if (this.currentSeries?.id === id) this.view = 'list';
                    this.showToast('Deleted');
                },

                async saveSeries() {
                    if (!this.seriesForm.name) return;
                    await chronosDB.saveSeries(this.seriesForm);
                    await this.loadSeries();
                    this.modals.series = false;
                    this.showToast('Saved');
                },

                async openSeriesDetail(series) {
                    this.currentSeries = series;
                    this.analysisSelection = (series.config && series.config.analysisSelection) 
                        ? [...series.config.analysisSelection] 
                        : ['mean', 'median', 'max', 'min'];
                    if (series.config && series.config.chartSettings) {
                        this.chartSettings = { ...series.config.chartSettings };
                    } else {
                        this.chartSettings={period:'none',runningMetric:'',window:3,logScale:false,range: 'all'};
                    }
                
                    this.view = 'detail';
                    this.detailSubView = 'chart';
                    await this.loadEntries(series.id);
                    this.$nextTick(() => {
                        this.updateChart();
                    });
                },

                async loadEntries(id) {
                    this.currentSeriesEntries = await chronosDB.getEntriesForSeries(id);
                    this.currentSeriesEntries.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
                    this.recalculateSummaryDisplay();
                    if (this.detailSubView === 'chart') this.$nextTick(() => this.initChart());
                },

                recalculateSummaryDisplay() {
                    if (!this.currentSeries || !this.currentSeriesEntries.length || !this.currentSeries.config) return;
                    
                    this.currentSeries.summaryDisplay = calculateSeriesSummary(
                        this.currentSeries,
                        this.currentSeriesEntries,
                        formatDuration.bind(this)
                    );
                },

                async saveSeriesConfig() {
                    if (!this.currentSeries) return;
                    this.currentSeries.config.analysisSelection = [...this.analysisSelection];
                    this.currentSeries.config.chartSettings = { ...this.chartSettings };
                    this.recalculateSummaryDisplay();
                    await chronosDB.saveSeries(this.currentSeries);
                    await this.loadSeries();
                },

                get activeStats() {
                    if (!this.currentSeriesEntries.length) return [];
                    const vals = this.currentSeriesEntries.map(e => e.value).sort((a,b) => a-b);
                    const s = calculateStats(vals, this.currentSeriesEntries.map(e => e.value), this.currentSeriesEntries);
                    return this.metrics.filter(m => this.analysisSelection.includes(m.id)).map(m => ({ 
                        label: m.label, 
                        value: this.currentSeries.type === 'time' ? formatDuration(s[m.id]) : (s[m.id] ? s[m.id].toLocaleString() : '0')
                    }));
                },

                handleCalendarDayClick(d) {
                    this.activeSeriesForEntry = this.currentSeries;
                    this.editingEntry = null;
                    const now = new Date();
                    const targetDate = new Date(d.date);
                    targetDate.setHours(now.getHours(), now.getMinutes());
                    this.entryForm = { timestamp: getFormattedISO(targetDate), value: '', notes: '', dhms: { d:0, h:0, m:0, s:0 } };
                    this.modals.entry = true;
                },

                changeSubView(v) { this.detailSubView = v; if (v === 'chart') this.initChart(); },
                
                initChart() {
                    this.$nextTick(() => {
                        initChart('seriesChart', this.currentSeries, this.chartSettings, this.metrics, formatDuration.bind(this));
                        this.updateChart();
                    });
                },

                updateChart() {
                    updateChart(getChartInstance(), this.currentSeries, this.currentSeriesEntries, this.chartSettings, this.metrics, this.analysisSelection);
                },
                
                async openAddEntryModal(s) { 
                    this.activeSeriesForEntry = s; 
                    const action = s.config?.quickAddAction || 'manual';

                    // Chronometer Logic
                    if (action === 'chronometer' && s.type === 'time') {
                        const now = new Date();
                        if (!s.startTime) {
                            s.startTime = now.toISOString();
                            await chronosDB.saveSeries(s);
                            this.showToast('Chronometer Started');
                            return;
                        } else {
                            const start = new Date(s.startTime);
                            const elapsedSeconds = Math.floor((now - start) / 1000);
                            s.startTime = null;
                            this.editingEntry = null;
                            this.entryForm = { 
                                timestamp: getFormattedISO(now), 
                                value: elapsedSeconds, 
                                notes: `Elapsed: ${formatDuration(elapsedSeconds)}`,
                                dhms: secondsToDHMS(elapsedSeconds) 
                            };
                            await this.saveEntry();
                            this.showToast(`Recorded ${formatDuration(elapsedSeconds)}`);
                            return;
                        }
                    }

                    if (action === 'increment' && s.type === 'number') {
                        const todayStr = new Date().toISOString().split('T')[0];
                        const entries = await chronosDB.getEntriesForSeries(s.id);
                        const todayEntry = entries.find(ent => ent.timestamp.startsWith(todayStr));
                        if (todayEntry) {
                            this.editingEntry = todayEntry;
                            this.entryForm = { ...todayEntry, value: (todayEntry.value || 0) + 1 };
                        } else {
                            this.editingEntry = null;
                            this.entryForm = { timestamp: getFormattedISO(), value: 1, notes: '' };
                        }
                        this.saveEntry();
                        return;
                    }

                    if (action === 'currentTime' && s.type === 'time') {
                        const now = new Date();
                        const secondsSinceMidnight = (now.getHours() * 3600) + (now.getMinutes() * 60) + now.getSeconds();
                        this.editingEntry = null;
                        this.entryForm = { timestamp: getFormattedISO(), value: secondsSinceMidnight, notes: '', dhms: secondsToDHMS(secondsSinceMidnight) };
                        this.saveEntry();
                        return;
                    }

                    this.editingEntry = null; 
                    this.entryForm = { timestamp: getFormattedISO(), value: '', notes: '', dhms: { d:0, h:0, m:0, s:0 } }; 
                    this.modals.entry = true; 
                },
                
                async saveEntry() {
                    if (!this.entryForm.timestamp) return;
                    let finalVal;
                    if (this.activeSeriesForEntry.type === 'time') {
                        const {d, h, m, s} = this.entryForm.dhms;
                        finalVal = (parseInt(d||0)*86400) + (parseInt(h||0)*3600) + (parseInt(m||0)*60) + parseInt(s||0);
                    } else { 
                        finalVal = parseFloat(this.entryForm.value); 
                    }
                    if (isNaN(finalVal)) return;

                    let cleanTimestamp = this.entryForm.timestamp.replace('T', ' ');
                    const entryData = { 
                        timestamp: cleanTimestamp, 
                        notes: this.entryForm.notes, 
                        seriesId: this.activeSeriesForEntry.id, 
                        value: finalVal 
                    };
                    
                    if (this.editingEntry) entryData.id = this.editingEntry.id;
                    
                    await chronosDB.saveEntry(entryData);
                    
                    // Update series summary
                    const allEntries = await chronosDB.getEntriesForSeries(this.activeSeriesForEntry.id);
                    const tempSeries = JSON.parse(JSON.stringify(this.activeSeriesForEntry));
                    tempSeries.summaryDisplay = calculateSeriesSummary(tempSeries, allEntries, formatDuration.bind(this));
                    await chronosDB.saveSeries(tempSeries);
                    
                    await this.loadSeries();
                    if (this.currentSeries && this.currentSeries.id === this.activeSeriesForEntry.id) {
                        await this.loadEntries(this.activeSeriesForEntry.id);
                    }
                    this.modals.entry = false;
                    this.showToast('Saved');
                },

                editEntry(e) { 
                    this.activeSeriesForEntry = this.currentSeries; 
                    this.editingEntry = e; 
                    this.entryForm = { ...e, dhms: this.activeSeriesForEntry.type === 'time' ? secondsToDHMS(e.value) : { d:0, h:0, m:0, s:0 } }; 
                    this.modals.entry = true; 
                },

                async deleteEntry(id) { 
                    if (confirm('Delete entry?')) { 
                        await chronosDB.deleteEntry(id);
                        await this.loadEntries(this.currentSeries.id);
                    } 
                },

                showToast(m) { this.toast.message = m; this.toast.show = true; setTimeout(() => this.toast.show = false, 3000); }
            }));
        Alpine.start()

    </script>
</body>
</html>